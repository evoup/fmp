<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>new campaign</title>
  <link rel="stylesheet" type="text/css" href="../../assets/css/default/base.css?t=20150310012932">
  <link rel="stylesheet" type="text/css" href="../../assets/css/default/menu.css?t=20150310012932">
  <link rel="stylesheet" type="text/css" href="../../assets/css/default/dashboard.css?t=20150310012932">
  <link rel="stylesheet" type="text/css" href="../../assets/css/default/fbaccount.css?t=20150310012932">
  <link rel="stylesheet" type="text/css" href="../../assets/css/default/table.css?t=20150310012932">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="../../assets/css/default/sidebar.css?t=20150310012932">
  <link rel="stylesheet" type="text/css" href="../../assets/css/libs/datepicker3.css?t=20150310012932">
  <link rel="stylesheet" type="text/css" href="../../assets/css/libs/jquery-ui.css?t=20150310012932">
  <script type="text/javascript" src="../../assets/js/libs/jquery-1.11.2.min.js?t=20150310012932"></script>
  <script type="text/javascript" src="../../assets/js/libs/jquery.tmpl.js?t=20150310012932"></script>
  <script type="text/javascript" src="../../assets/js/libs/bbq_init.js?t=20150310012932"></script>
  <script type="text/javascript" src="../../assets/js/libs/jquery.ba-bbq.js?t=20150310012932"></script>
  <script type="text/javascript" src="../../assets/js/base.js?t=20150310012932"></script>
  <script type="text/javascript" src="../../assets/js/libs/jquery-ui.min.js?t=20150310012932"></script>
</head>
<body>
    <div class="wrapper">
        <!--fmp_header-->
        <div class="header">
            <a href="/" title="visit fmp"><h1 class="mainlogo"><u style="display:none;">FMP</u></h1></a>
            <span class="beta">beta</span>
            <div class="userarea"><a href="/profiles/" id="user_profile_a"></a> | <a class="btn btn-sm btn-info" href="../" id="logout_btn" onclick="javascript:return false;">logout</a></div>
            <span class="description">a facebook  partner</span>
        </div>
        <script id="headerTemplate" type="text/x-jquery-tmpl">${UserName}</script>
        <!--/fmp_header-->


        <!--fmp_navibar-->
        <div class="navibar">
            <div class="navi">
                <ul>
                    <li><a href="../../../camps/">YOUR CAMPAIGNS</a></li>
                    <li><a href="../../../campaign/new/">NEW CAMPAIGN</a></li>
                    <li><a href="../../../report/">REPORT</a></li>
                    <li><a href="../../../settings/">SETTINGS</a></li>
                </ul>
                <div id="camp_select_div">
                    select camp:
                    <select>
                        <option>please select</option>
                        <option>xxxxx</option>
                    </select>
                </div>
            </div>
        </div>
        <!--/fmp_navibar-->


        <!--main-->
        <div class="main-content">
            <div class="row" id="main-area" style="text-align:center">
                <div class="col-sm-2" id="sidebar-area" style="text-align:left">
                    <!--sidebar-->
                    <!--/sidebar-->
                </div>
                <div class="col-sm-9 bbq-content" id="ad_edit_area" style="text-align:left;float:left">
                    <!--step1-->
                    <!--/step1-->
                </div>
            </div>
        </div>
        <!--/main-->
        <!--fmp_footer-->
        <div class="footer">
            <h2 class="logo">madhouse</h2>
            <h3 class="credits">Developed by Madhouse Inc</h3>
        </div>
        <!--/fmp_footer-->
    </div>
    <script>
          var cache = {
              '': $('.bbq-default')
          };
      $(document).ready(function(){
          loading()
          $.ajax({
            url:baseConf.api_prefix+"/get/login/@self",
            method:"GET",
            success: function(data){
                    if (data.status=="false") { //没有登录退出
                        location.href="../"
                    }
                    var user = [
                    { UserName: data.username }
                    ]
                    $("#headerTemplate").tmpl(user).appendTo('.header #user_profile_a');
                }
            })
          bind_logout_btn()
    })
    //根据url参数判断是第几步，下载模板和ajax数据动态构造编辑页面
    //新的方法一次性下载全部模板<!--{{{-->
    //gced:global campaign edit data
    var gced={adaccounts:"",audience:"",tpl_sidebar:"",tpl_step1:"",tpl_step2:"",tpl_step3:"",tpl_step4:"",tpl_step5:""};
$.when(
  // Get the all available ad accounts
  $.get(baseConf.api_prefix+"/get/campaign/@step1", function(data) {
      gced.adaccounts=data
  }),
  $.get(baseConf.api_prefix+"/get/campaign/@step3", function(data) {
      gced.audience=data
  }),
  $.get(baseConf.domain+"/templates/camp.sidebar.htm?t=20150310012932", function(data) {
     gced.tpl_sidebar=data
  }),
  $.get(baseConf.domain+"/templates/camp_step1.htm?t=20150310012932", function(data) {
     gced.tpl_step1=data
  }),
  $.get(baseConf.domain+"/templates/camp_step2.htm?t=20150310012932", function(data) {
     gced.tpl_step2=data
  }),
  $.get(baseConf.domain+"/templates/camp_step3.htm?t=20150310012932", function(data) {
     gced.tpl_step3=data
  }),
  $.get(baseConf.domain+"/templates/camp_step4.htm?t=20150310012932", function(data) {
     gced.tpl_step4=data
  }),
  $.get(baseConf.domain+"/templates/camp_step5.htm?t=20150310012932", function(data) {
     gced.tpl_step5=data
  }),
  $.getScript(baseConf.domain+"/assets/js/libs/prettify.min.js?t=20150310012932"),
  $.getScript(baseConf.domain+"/assets/js/libs/bootstrap-datepicker.js?t=20150310012932"),
  $.getScript(baseConf.domain+"/assets/js/location_map.js?t=20150310012932"),
  $.getScript(baseConf.domain+"/assets/js/libs/jquery.autocomplete.multiselect.js?t=20150310012932")
).then(function() {
    $("#main-loading").remove()
    $.tmpl(gced.tpl_sidebar,null).appendTo('#sidebar-area');
    $(window).bind( 'hashchange', function(e) {
        var url = $.param.fragment();
        $( '.bbq-content' ).children( ':visible' ).hide();
        arr=url.split("/")
        stp=(arr.length<2)?1:arr[1]
        changeNav(stp)
        if ( cache[ url ] ) {
            cache[url].show()
        } else {
            switch(stp){
                case("1"):
                cache[url]=$.tmpl(gced["tpl_step"+stp],gced.adaccounts).appendTo('#ad_edit_area');
                break;
                case("2"):
                cache[url]=$.tmpl(gced["tpl_step"+stp],gced.adaccounts).appendTo('#ad_edit_area');
                trackingProcess()
                break;
                case("3"):
                cache[url]=$.tmpl(gced["tpl_step"+stp],gced.audience).appendTo('#ad_edit_area');
                AudienceProcess()
                break;
                default:
                cache[url]=$.tmpl(gced["tpl_step"+stp],gced.adaccounts).appendTo('#ad_edit_area');
                break;
            }
        }
    })
    $(window).trigger( 'hashchange' );
    if ( (($.param.fragment()).split("/")).length<2 ) {
       cache[""]=$.tmpl(gced["tpl_step1"],gced.adaccounts).appendTo('#ad_edit_area');
    }
});
<!--}}}-->

      function loading(){
        $('#main-area').append("<div id=\"main-loading\" style=\"margin-left:auto;margin-right:auto;padding-top:200px;color:#bbb;font-size:30px\"><i class=\"fa fa-cog fa-spin fa-3x fa-fw margin-bottom\"></i>loading...</div>")
    }
    function bind_logout_btn(){
       $("#logout_btn").bind("click",function(){
          $.ajax({
             url: baseConf.api_prefix+"/delete/login/@self",
             type: "GET",
             success: function(data){
                if (data.status=="true") {
                   location.href="http://"+document.domain;
               }
           }
       })
      })
   }
   function changeNav(step){
       for(i=0;i<6;i++){
           $("#fmp_leftmenu > ul > li:nth-child("+i+")").attr('class','')
       }
       $("#fmp_leftmenu > ul > li:nth-child("+step+")").attr('class','active')
       location.href=baseConf.domain+"/campaign/new/#step/"+step
   }
   function goStep(step){
       switch(step){
           case(step):
           current_step=step-1
           d=$("#form_camp_step"+current_step).serialize()
           save_step=step-1
           $.ajax({
               url: baseConf.api_prefix+"/update/campaign/@step"+save_step, 
               type: "POST",
               data:d,
               success: function(data){
                   $("code").html("")
                   if (data.status=="true") {
                       location.href=baseConf.domain+"/campaign/new/#step/"+step
                       changeNav(step)
                   } else {
                       err_msg=data.err_msg
                       for (i=0;i<err_msg.length;i++) {
                           for ( var id in err_msg[i] ){
                               alert_dom_id="label[for="+id+"] code"
                               $(alert_dom_id).text(err_msg[i][id])
                           }
                      }
                   }
               }
           })
           break;
           default:
               changeNav(step)
               $("#ad_edit_area").html("")
               $.tmpl(gced["tpl_step"+step],null).appendTo('#ad_edit_area')
           break;
       }
   }
   function goStepPram(obj){
      step=obj.step
      pram=obj.pram
      changeNav(step)
      $("#ad_edit_area").html("");
      $.tmpl(gced["tpl_step"+step],pram).appendTo('#ad_edit_area');
   }
  function routeCampUrlAct(){
      url=window.location.href
      n=url.indexOf("#step")
      if (n>=0){ //执行指定的路由
          url_sub=url.substr(n)
          sp_arr=url_sub.split("#step/")
          //会调用第"+sp_arr[1]+"页的方法
          return parseInt(sp_arr[1])
      } else { //不然就是第一页
          return 1
      }
  }
  function trackingProcess(){
      function trackingInit(){
          //google analytics
          if ($("input[name='ga_enable']").is(":checked")) {
              for(i=2;i<5;i++){
                 $("#form_camp_step2 > div:nth-child("+i+")").css("display","block")
              }
          } else {
              for(i=2;i<5;i++){
                 $("#form_camp_step2 > div:nth-child("+i+")").css("display","none")
              }
          }
          //sigmad tracking code
          if ($("input[name='sm_enable']").is(":checked")) {
              $("#form_camp_step2 > div:nth-child(7)").css("display","block")
          } else {
              $("#form_camp_step2 > div:nth-child(7)").css("display","none")
          }
          //facebook convert pixel
          if ($("input[name='fb_enable']").is(":checked")) {
              $("#form_camp_step2 > div:nth-child(10)").css("display","block")
          } else {
              $("#form_camp_step2 > div:nth-child(10)").css("display","none")
          }
      }
      function bindTrackingCheckBox(){
          $("input[name='ga_enable'],input[name='sm_enable'],input[name='fb_enable']").on('click',function(){trackingInit()})
      }
      trackingInit()
      bindTrackingCheckBox()
  }
  function AudienceProcess(){
      function audienceInit(){
          $("#form_camp_step3 > div > div > div:nth-child(1) > div:nth-child(6)").css(
          "display",
          $("input[name='age_split']").is(":checked")?"block":"none"
          )
          $("#form_camp_step3 > div > div > div:nth-child(1) > div:nth-child(12)").css(
              "display",
              $("input[name='save_template']").is(":checked")?"block":"none"
          )
      }
      function bindLocAutoComplete(){
          //预先载入一个假的自动完成
          savedCountries="";
          $("#fmplocation_autocomplete").wrap("<div class=\"ui-autocomplete-multiselect ui-state-default ui-widget\" id=\"fmp_loc_autocomplete_dummy\"></div>")
          $.each(gced.audience.fmplocation,function(k,v){
              console.log(v)
              savedCountries+="<div class=\"ui-autocomplete-multiselect-item\">"+v+"<span class=\"ui-icon ui-icon-close\"></span></div>"
          })
          $("#fmplocation_autocomplete").before(savedCountries)
          $(".ui-icon,.ui-icon-close").bind('click',function(){
              $(this).parent().remove()
          })
          var contrys=[]
          $.each(fmp_loc_dic,function(k,v){contrys.push(v)})
          $("#fmplocation_autocomplete").on('click',function(){
              if ($("#fmplocation_autocomplete").parent().attr("id")=="fmp_loc_autocomplete_dummy"){
                  $(".ui-autocomplete-multiselect-item").remove()
                  $("#fmplocation_autocomplete").unwrap()
              }
              $("#fmplocation_autocomplete").autocomplete({
                  source: contrys,
                   multiselect: true
              });
              $("#fmplocation_autocomplete").parent().attr("id","fmp_loc_autocomplete")
              $("#fmplocation_autocomplete").before(savedCountries)
              savedCountries=""
              $(".ui-icon,.ui-icon-close").bind('click',function(){$(this).parent().remove()})
              $("#fmplocation_autocomplete").focus()
              $("#form_camp_step3 input").on('blur',function(event) {
                  arr=[];
                  event.stopPropagation();
                  $.each($(".ui-autocomplete-multiselect-item"),function(k,v){
                      arr.push($(this).text())
                  })
                  $("input[name=fmplocation]").val(($.unique(arr)).join('|'))
              })
          })
      }
      audienceInit()
      bindLocAutoComplete()
      $("input[name='age_split'],input[name='save_template']").on('click',function(){audienceInit()})
  }
</script>
</body>
</html>
